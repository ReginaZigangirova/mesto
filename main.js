(()=>{"use strict";class e{constructor(e,t,r,s,n){var i=r.handleCardClick;this._name=e.name,this._link=e.link,this._likes=e.likes,this._id=e.id,this._userId=e.userId,this._ownerId=e.ownerId,this._templateSelector=t,this._handleCardClick=i,this._handleDeleteClick=s,this._handleLikeClick=n}_getTemplate(){return document.querySelector(this._templateSelector).content.querySelector(".card__elements").cloneNode(!0)}isLiked(){return this._likes.find((e=>e._id===this._userId))}setLikes(e){this._likes=e,this._element.querySelector(".card__like-count").textContent=this._likes.length,this.isLiked()?this._addLike():this._removeLike()}_addLike(){this._likeButton.classList.add("card__like_active")}_removeLike(){this._likeButton.classList.remove("card__like_active")}createCard(){return this._element=this._getTemplate(),this._cardImage=this._element.querySelector(".card__photo"),this._cardImage.src=this._link,this._cardImage.alt=this._name,this._element.querySelector(".card__tittle").textContent=this._name,this._likeButton=this._element.querySelector(".card__like"),this._setEventListeners(),this.setLikes(this._likes),this._ownerId!==this._userId&&(this._element.querySelector(".card__delete").style.display="none"),this._element}deleteHandler(){this._element.querySelector(".card__delete").closest(".card__elements").remove()}_setEventListeners(){this._element.querySelector(".card__delete").addEventListener("click",(()=>{this._handleDeleteClick(this._id)})),this._likeButton.addEventListener("click",(()=>{this._handleLikeClick(this._id)})),this._cardImage.addEventListener("click",(()=>{this._handleCardClick(this._name,this._link)}))}}var t={formSelector:".popup__form",inputSelector:".popup__input",submitButtonSelector:".popup__save",inactiveButtonClass:".popup__save_disabled",inputErrorClass:".popup__input-error",errorClass:".popup__input-error_active"},r=document.querySelector(".popup_type_edit"),s=document.querySelector(".profile__button"),n=r.querySelector(".popup__form"),i=document.querySelector(".popup_type_add-card"),o=document.querySelector(".profile__button-plus"),a=i.querySelector(".popup__form"),l=document.querySelector(".profile__pen"),c=document.querySelector(".popup_type_avatar").querySelector(".popup__form"),h=document.querySelector(".card");class d{constructor(e,t){this._config=e,this._form=t,this._inputSelector=e.inputSelector}_hideError(e){this.errorElement=this._form.querySelector("#".concat(e.id,"-error")),e.classList.remove(this._config.inputErrorClass),this.errorElement.classList.remove(this._config.errorClass),this.errorElement.textContent=""}_showError(e){this.errorElement=this._form.querySelector("#".concat(e.id,"-error")),e.classList.add(this._config.inputErrorClass),this.errorElement.classList.add(this._config.errorClass),this.errorElement.textContent=e.validationMessage}_toggleButtonState(){var e=this._form.checkValidity();this._buttonElement.disabled=!e}_checkInputValidity(e){e.validity.valid?this._hideError(e):this._showError(e)}_setEventListeners(){this._form.addEventListener("submit",(e=>{e.preventDefault()})),this._inputList=this._form.querySelectorAll(this._config.inputSelector),this._buttonElement=this._form.querySelector(this._config.submitButtonSelector),this._toggleButtonState(),this._inputList.forEach((e=>{e.addEventListener("input",(()=>{this._checkInputValidity(e),this._toggleButtonState()}))}))}resetErrorInput(){this._inputList.forEach((e=>{this._hideError(e)})),this._toggleButtonState()}enableValidation(){this._setEventListeners()}}function _(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class u{constructor(e){_(this,"_handleEscClose",(e=>{"Escape"===e.key&&this.close()})),_(this,"_handleOverlayClose",(e=>{e.target.classList.contains("popup_opened")&&this.close()})),_(this,"_handleCloseButton",(e=>{e.target.classList.contains("popup__close")&&this.close()})),this._popup=document.querySelector(e)}open(){this._popup.classList.add("popup_opened"),this.setEventListeners()}close(){this._popup.classList.remove("popup_opened"),this._removeEventListeners()}setEventListeners(){document.addEventListener("keydown",this._handleEscClose),document.addEventListener("click",this._handleOverlayClose),this._popup.addEventListener("click",this._handleCloseButton)}_removeEventListeners(){document.removeEventListener("keydown",this._handleEscClose),document.removeEventListener("click",this._handleOverlayClose),this._popup.removeEventListener("click",this._handleCloseButton)}}class p extends u{constructor(e,t){var r=t.submitHandler;super(e),this._submitHandler=r,this._popupForm=this._popup.querySelector(".popup__form"),this._inputsList=this._popup.querySelectorAll(".popup__input"),this._loadingButton=this._popup.querySelector(".popup__save"),this._buttonText=this._loadingButton.textContent}_getInputValues(){return this._inputValue={},this._inputsList.forEach((e=>{this._inputValue[e.name]=e.value})),this._inputValue}cangeSubmitHandler(e){var t=e.newSubmitHandler;this._submitHandler=t}setEventListeners(){super.setEventListeners(),this._popupForm.addEventListener("submit",(e=>{e.preventDefault(),this._submitHandler(this._getInputValues())}))}renderLoading(e){this._loadingButton.textContent=e?"Сохранение...":this._buttonText}close(){super.close(),this._popupForm.removeEventListener("submit",this._formSubmitHandler),this._popupForm.reset()}}var m,v=new class{constructor(e){var t=e.baseUrl,r=e.headers;this._headers=r,this._baseUrl=t}_checkResponse(e){return e.ok?e.json():Promise.reject(e.status)}getProfile(){return fetch("".concat(this._baseUrl,"/users/me"),{headers:this._headers}).then(this._checkResponse)}getInitialCards(){return fetch("".concat(this._baseUrl,"/cards"),{headers:this._headers}).then(this._checkResponse)}editProfile(e,t){return fetch("https://mesto.nomoreparties.co/v1/cohort-37/users/me",{method:"PATCH",headers:{authorization:"0422eec2-f505-49eb-b34a-7793c9abd9fe","Content-Type":"application/json"},body:JSON.stringify({name:e,about:t})}).then(this._checkResponse)}addCard(e,t){return fetch("https://mesto.nomoreparties.co/v1/cohort-37/cards",{method:"POST",headers:this._headers,body:JSON.stringify({name:e,link:t})}).then(this._checkResponse)}deleteCard(e){return fetch("".concat(this._baseUrl,"/cards/").concat(e," "),{method:"DELETE",headers:this._headers}).then(this._checkResponse)}deleteLike(e){return fetch("".concat(this._baseUrl,"/cards/").concat(e,"/likes "),{method:"DELETE",headers:this._headers}).then(this._checkResponse)}addLike(e){return fetch("".concat(this._baseUrl,"/cards/").concat(e,"/likes "),{method:"PUT",headers:this._headers}).then(this._checkResponse)}setAvatar(e){return fetch("".concat(this._baseUrl,"/users/me/avatar"),{method:"PATCH",headers:this._headers,body:JSON.stringify({avatar:e})}).then(this._checkResponse)}}({baseUrl:"https://mesto.nomoreparties.co/v1/cohort-37",headers:{authorization:"0422eec2-f505-49eb-b34a-7793c9abd9fe","Content-Type":"application/json"}});function f(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,s=new Array(t);r<t;r++)s[r]=e[r];return s}Promise.all([v.getInitialCards(),v.getProfile()]).then((e=>{var t,r,s=(r=2,function(e){if(Array.isArray(e))return e}(t=e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var s,n,i=[],o=!0,a=!1;try{for(r=r.call(e);!(o=(s=r.next()).done)&&(i.push(s.value),!t||i.length!==t);o=!0);}catch(e){a=!0,n=e}finally{try{o||null==r.return||r.return()}finally{if(a)throw n}}return i}}(t,r)||function(e,t){if(e){if("string"==typeof e)return f(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?f(e,t):void 0}}(t,r)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),n=s[0],i=s[1];m=i._id,L.setUserInfo(i.name,i.about),L.setUserAvatar(i.avatar),n.reverse(),n.forEach((e=>{var t=q({name:e.name,link:e.link,likes:e.likes,id:e._id,userId:m,ownerId:e.owner._id});w.addItem(t)}))})).catch((e=>{console.log("Ошибка: ".concat(e))}));var k=new d(t,n),y=new d(t,a),b=new d(t,c);k.enableValidation(),y.enableValidation(),b.enableValidation(),l.addEventListener("click",(()=>{E.open(),b.resetErrorInput()}));var E=new p(".popup_type_avatar",{submitHandler:e=>{v.setAvatar(e.avatar).then((e=>{L.setUserAvatar(e.avatar)})),E.close()}}),L=new class{constructor(e){var t=e.profileName,r=e.profileDescription,s=e.avatar;this._nameElement=document.querySelector(t),this._jobElement=document.querySelector(r),this._avatarElement=document.querySelector(s)}getUserInfo(){return this._userData={name:this._nameElement.textContent,about:this._jobElement.textContent,avatar:this._avatarElement.src},this._userData}setUserInfo(e,t,r){this._nameElement.textContent=e,this._jobElement.textContent=t}setUserAvatar(e){this._avatarElement.src=e}}({profileName:".profile__name",profileDescription:".profile__job",avatar:".profile__avatar"});s.addEventListener("click",(function(){g.open();var e=L.getUserInfo();nameInput.value=e.name,jobInput.value=e.about,k.resetErrorInput()}));var g=new p(".popup_type_edit",{submitHandler:e=>{g.renderLoading(!0),v.editProfile(e.name,e.about).then((e=>{L.setUserInfo(e.name,e.about),g.close()})).finally((()=>{g.renderLoading(!1)}))}});o.addEventListener("click",(()=>{S.open(),y.resetErrorInput()}));var S=new p(".popup_type_add-card",{submitHandler:e=>{S.renderLoading(!0),v.addCard(e.name,e.link).then((e=>{var t=q({name:e.name,link:e.link,likes:e.likes,id:e._id,userId:m,ownerId:e.owner._id});w.prependItem(t),S.close()})).finally((()=>{S.renderLoading(!1)}))}}),C=new p(".popup_type_delete-confirm",{}),I=new class extends u{constructor(e){super(e),this._popupImg=this._popup.querySelector(".popup__img"),this._popupDescription=this._popup.querySelector(".popup__title")}open(e,t){this._popupDescription.textContent=e,this._popupImg.src=t,this._popupImg.alt=e,super.open()}}(".popup_type_img");function q(t){var r=new e(t,".card-template",{handleCardClick:(e,t)=>{I.open(e,t)}},(e=>{C.open(),C.cangeSubmitHandler({newSubmitHandler:()=>{C.renderLoading(!0),v.deleteCard(e).then((e=>{r.deleteHandler(),C.close()})).finally((()=>{C.renderLoading(!1)}))}})}),(e=>{r.isLiked()?v.deleteLike(e).then((e=>{r.setLikes(e.likes)})):v.addLike(e).then((e=>{r.setLikes(e.likes)}))}));return r.createCard()}var w=new class{constructor(e,t){var r=e.items,s=e.renderer;this._renderedItems=r,this._renderer=s,this._container=t}addItem(e){this._container.append(e)}prependItem(e){this._container.prepend(e)}renderItems(){this._renderedItems.forEach((e=>{this._renderer(e)}))}}({items:[],renderer:e=>{var t=q(e);w.addItem(t)}},h);w.renderItems()})();